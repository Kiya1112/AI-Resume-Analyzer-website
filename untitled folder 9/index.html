<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Analyzer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style for the output */
        .output-card h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #4f46e5; /* indigo-700 */
            margin-bottom: 0.75rem; /* mb-3 */
            border-bottom: 2px solid #eef2ff; /* border-b-2 border-indigo-50 */
            padding-bottom: 0.5rem; /* pb-2 */
        }
        .output-card h2 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            margin-top: 1.5rem; /* mt-6 */
            margin-bottom: 1rem; /* mb-4 */
            border-bottom: 2px solid #e0e7ff; /* border-b-2 border-indigo-200 */
            padding-bottom: 0.5rem; /* pb-2 */
        }
        .output-card ul {
            list-style-type: disc;
            padding-left: 1.5rem; /* pl-6 */
            margin-bottom: 1rem; /* mb-4 */
        }
        .output-card li {
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .output-card strong {
            color: #3730a3; /* indigo-800 */
        }
        .output-card p {
            margin-bottom: 0.75rem; /* mb-3 */
        }
        .source-link {
            display: inline-block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4f46e5; /* indigo-700 */
            background-color: #eef2ff; /* indigo-100 */
            padding: 0.25rem 0.75rem; /* px-3 py-1 */
            border-radius: 9999px; /* rounded-full */
            margin-right: 0.5rem; /* mr-2 */
            margin-bottom: 0.5rem; /* mb-2 */
            text-decoration: none;
        }
        .source-link:hover {
            background-color: #e0e7ff; /* indigo-200 */
            text-decoration: underline;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-3xl font-bold text-indigo-700">AI Resume & Job Assistant</h1>
            <p class="text-gray-600 mt-1">Paste your resume, get instant analysis and job leads.</p>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
        <div class="lg:grid lg:grid-cols-3 lg:gap-8">

            <!-- Left Column (Inputs & Controls) -->
            <aside class="lg:col-span-1 lg:sticky lg:top-8 space-y-6">
                
                <!-- Resume Input -->
                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200">
                    <label for="resume-text" class="block text-sm font-medium text-gray-700">1. Paste Your Resume</label>
                    <textarea id="resume-text" rows="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Paste your full resume text here..."></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 space-y-4">
                    <h3 class="text-lg font-medium text-gray-900">2. Run Analysis</h3>

                    <!-- Job Filters -->
                    <div class="space-y-3 pt-2">
                        <h4 class="text-sm font-medium text-gray-700">Optional Filters</h4>
                        <div>
                            <label for="location" class="block text-xs font-medium text-gray-600">Location</label>
                            <input type="text" id="location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., 'Remote' or 'New York, NY'">
                        </div>
                        <div>
                            <label for="date-posted" class="block text-xs font-medium text-gray-600">Date Posted</label>
                            <select id="date-posted" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option value="any">Any Time</option>
                                <option value="past_24_hours">Past 24 Hours</option>
                                <option value="past_week">Past Week</option>
                                <option value="past_month">Past Month</option>
                            </select>
                        </div>
                    </div>
                    <!-- End Job Filters -->

                    <button id="btn-jobs" class="w-full flex justify-center items-center gap-2 bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">
                        Suggest Job Postings
                    </button>
                    <button id="btn-critique" class="w-full flex justify-center items-center gap-2 bg-gray-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:bg-gray-800 transition-colors duration-200">
                        Critique My Resume
                    </button>
                    <button id="btn-contacts" class="w-full flex justify-center items-center gap-2 bg-gray-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:bg-gray-800 transition-colors duration-200">
                        Find Networking Contacts
                    </button>
                </div>

                <!-- Error Message Box -->
                <div id="error-box" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                    <strong class="font-bold">Error:</strong>
                    <span id="error-message" class="block sm:inline">Something went wrong.</span>
                </div>

            </aside>

            <!-- Right Column (Outputs) -->
            <section class="lg:col-span-2 mt-8 lg:mt-0 space-y-6">

                <!-- Loading Spinner -->
                <div id="loading-spinner" class="hidden bg-white p-10 rounded-xl shadow-lg border border-gray-200 text-center">
                    <div class="spinner mx-auto"></div>
                    <p class="mt-4 text-lg font-medium text-gray-600">Analyzing... This may take a moment.</p>
                </div>

                <!-- Initial Placeholder -->
                <div id="placeholder" class="bg-white p-10 rounded-xl shadow-lg border border-gray-200 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">Get Started</h3>
                    <p class="mt-1 text-sm text-gray-500">Your AI-powered job analysis will appear here.</p>
                </div>
                
                <!-- Results Container -->
                <div id="results-container" class="hidden space-y-6">
                    <!-- Job Postings Output -->
                    <div id="jobs-output" class="output-card bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
                        <h3>Recommended Job Postings</h3>
                        <div id="jobs-content"></div>
                        <div id="jobs-sources" class="mt-4"></div>
                    </div>
                    
                    <!-- Resume Critique Output -->
                    <div id="critique-output" class="output-card bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
                        <h3>Resume Critique</h3>
                        <div id="critique-content"></div>
                    </div>

                    <!-- Contacts Output -->
                    <div id="contacts-output" class="output-card bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
                        <h3>Networking Contacts</h3>
                        <div id="contacts-content"></div>
                        <div id="contacts-sources" class="mt-4"></div>
                    </div>
                </div>

            </section>
        </div>
    </main>
    
    <footer class="text-center py-6 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-500">Powered by the Gemini API</p>
    </footer>

    <script>
        // Wait for the entire HTML document to be loaded before running any JavaScript
        document.addEventListener('DOMContentLoaded', () => {
            
            // Log to confirm the script is running
            console.log("DOM content loaded. Attaching event listeners...");

            // DOM Elements
            const resumeTextInput = document.getElementById('resume-text');
            const btnJobs = document.getElementById('btn-jobs');
            const btnCritique = document.getElementById('btn-critique');
            const btnContacts = document.getElementById('btn-contacts');
            
            // Filter Elements
            const locationInput = document.getElementById('location');
            const datePostedInput = document.getElementById('date-posted');
            
            const loadingSpinner = document.getElementById('loading-spinner');
            const placeholder = document.getElementById('placeholder');
            const resultsContainer = document.getElementById('results-container');
            
            const jobsOutput = document.getElementById('jobs-output');
            const jobsContent = document.getElementById('jobs-content');
            const jobsSources = document.getElementById('jobs-sources');
            
            const critiqueOutput = document.getElementById('critique-output');
            const critiqueContent = document.getElementById('critique-content');
            
            const contactsOutput = document.getElementById('contacts-output');
            const contactsContent = document.getElementById('contacts-content');
            const contactsSources = document.getElementById('contacts-sources');
            
            const errorBox = document.getElementById('error-box');
            const errorMessage = document.getElementById('error-message');

            // Log to confirm buttons are found
            console.log("Found buttons:", {
                jobs: btnJobs, 
                critique: btnCritique, 
                contacts: btnContacts
            });

            // --- Event Listeners ---
            
            btnJobs.addEventListener('click', () => {
                // Log on click
                console.log("Job Postings button clicked.");
                handleAnalysis('jobs');
            });
            btnCritique.addEventListener('click', () => {
                // Log on click
                console.log("Critique button clicked.");
                handleAnalysis('critique');
            });
            btnContacts.addEventListener('click', () => {
                // Log on click
                console.log("Contacts button clicked.");
                handleAnalysis('contacts');
            });

            /**
             * Main handler function to route analysis requests
             */
            async function handleAnalysis(type) {
                // Log on function start
                console.log(`handleAnalysis called with type: ${type}`);
                
                const resumeText = resumeTextInput.value.trim();
                const location = locationInput.value.trim();
                const datePosted = datePostedInput.value;

                if (!resumeText) {
                    // Log on error
                    console.log("Resume text is empty. Displaying error.");
                    displayError("Please paste your resume text.");
                    return;
                }

                clearDisplay();
                displayLoading(true);

                let outputElementContent, outputElementCard, outputElementSources;

                try {
                    switch (type) {
                        case 'jobs':
                            outputElementCard = jobsOutput;
                            outputElementContent = jobsContent;
                            outputElementSources = jobsSources;
                            break;
                        
                        case 'critique':
                            outputElementCard = critiqueOutput;
                            outputElementContent = critiqueContent;
                            break;
                            
                        case 'contacts':
                            outputElementCard = contactsOutput;
                            outputElementContent = contactsContent;
                            outputElementSources = contactsSources;
                            break;
                    }

                    // Call our serverless function with all the data
                    const result = await callServerlessFunction(resumeText, type, location, datePosted);
                    
                    outputElementContent.innerHTML = parseMarkdown(result.text);
                    
                    // Handle sources if they exist
                    if (result.sources && result.sources.length > 0) {
                        outputElementSources.innerHTML = '<strong>Found Sources:</strong><br>' + result.sources.map(source => 
                            `<a href="${source.uri}" target="_blank" class="source-link" title="${source.title}">${new URL(source.uri).hostname}</a>`
                        ).join(' ');
                    }

                    outputElementCard.classList.remove('hidden');
                    resultsContainer.classList.remove('hidden');

                } catch (error) { 
                    console.error(error);
                    displayError(error.message || "An unknown error occurred.");
                } finally {
                    displayLoading(false);
                }
            }

            /**
             * Calls our secure VERCEL serverless function
             */
            async function callServerlessFunction(resumeText, analysisType, location, datePosted) {
                // *** THIS IS THE IMPORTANT CHANGE FOR VERCEL ***
                // It must call /api/getAnalysis
                const functionUrl = '/api/getAnalysis'; 

                try {
                    const response = await fetch(functionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            resumeText: resumeText,
                            type: analysisType,
                            location: location,
                            datePosted: datePosted
                        })
                    });

                    if (!response.ok) {
                        // Read the error body ONCE as JSON
                        let errorBody;
                        try {
                            errorBody = await response.json();
                        } catch (e) {
                            // If the body isn't JSON, use the status text
                            throw new Error(response.statusText || `Serverless function failed with status ${response.status}`);
                        }
                        throw new Error(errorBody.error || `Serverless function failed with status ${response.status}`);
                    }

                    // Read the success body ONCE as JSON
                    return await response.json();
                    
                } catch (error) {
                    console.error("Error calling serverless function:", error);
                    throw new Error("Failed to get analysis. " + error.message);
                }
            }

            // --- Display & Utility Functions ---

            function displayLoading(isLoading) {
                if (isLoading) {
                    loadingSpinner.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                } else {
                    loadingSpinner.classList.add('hidden');
                }
            }

            function clearDisplay() {
                displayError(null);
                placeholder.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
                
                jobsOutput.classList.add('hidden');
                critiqueOutput.classList.add('hidden');
                contactsOutput.classList.add('hidden');
                
                jobsContent.innerHTML = '';
                jobsSources.innerHTML = '';
                critiqueContent.innerHTML = '';
                contactsContent.innerHTML = '';
                contactsSources.innerHTML = '';
            }

            function displayError(message) {
                if (message) {
                    errorMessage.textContent = message;
                    errorBox.classList.remove('hidden');
                } else {
                    errorBox.classList.add('hidden');
                }
            }

            /**
             * Simple function to strip all HTML tags
             */
            function stripTags(text) {
                if (!text) return '';
                return text.replace(/<[^>]*>?/gm, '');
            }

            /**
             * Simple Markdown to HTML parser for AI output
             * This now supports links, bold, italic, headers, and lists
             */
            function parseMarkdown(text) {
                if (!text) return '';
                
                // Step 1: Sanitize the text by removing any potential HTML tags
                let safeText = stripTags(String(text)); // Add String() for safety
                
                // Step 2: Apply our simple markdown
                return safeText
                    // Rule for Links: [Link Text](https://...)
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-indigo-600 hover:underline">$1</a>')
                    
                    // Rule for Bold: **Bold Text**
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                    
                    // Rule for Italic: *Italic Text*
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')     
                    
                    // Rule for Headers: ## Header Text
                    .replace(/^## (.*)$/gm, '<h2 class="text-xl font-semibold mt-4 mb-2">$1</h2>')
                    
                    // Rule for Bullets: - Bullet Text
                    .replace(/^\s*[\* \-]\s+(.*)$/gm, '<li>$1</li>') 
                    .replace(/(\<li\>.*\<\/li\>)/gs, '<ul>$1</ul>') // Wrap bullets in ul
                    
                    // Rule for Newlines
                    .replace(/\n/g, '<br>'); 
            }

        }); // --- Closes the DOMContentLoaded listener ---
    </script>
</body>
</html>

